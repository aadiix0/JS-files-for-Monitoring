name: JS File Monitor

on:
  schedule:
    - cron: '0 */12 * * *'  # Every 12 hours
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Clean up old monitored files
        run: |
          # Remove temporary folders from previous runs (GitHub Actions does this anyway)
          rm -rf monitored-files diffs
          
          # Optional: Remove baseline files that no longer have URL configs
          # This prevents orphaned baselines when you remove programs
          for platform in hackerone bugcrowd intigriti personal; do
            [ ! -d "baseline/$platform" ] && continue
            
            for baseline_program in baseline/$platform/*; do
              [ ! -d "$baseline_program" ] && continue
              
              program_name=$(basename "$baseline_program")
              
              # Check if program still has config file (flat or nested)
              config_exists=false
              
              # Check flat structure
              if [ -f "$platform/${program_name}.txt" ]; then
                config_exists=true
              fi
              
              # Check nested structure
              if [ -f "$platform/${program_name}/urls.txt" ] || [ -f "$platform/${program_name}/"*.txt ]; then
                config_exists=true
              fi
              
              # Remove baseline if config no longer exists
              if [ "$config_exists" = false ]; then
                echo "Removing orphaned baseline: $platform/$program_name"
                rm -rf "$baseline_program"
              fi
            done
          done

      - name: Scan and fetch all JS files
        timeout-minutes: 20
        run: |
          mkdir -p monitored-files diffs
          
          for platform in hackerone bugcrowd intigriti personal; do
            if [ ! -d "$platform" ]; then
              echo "Folder $platform not found, skipping..."
              continue
            fi
            
            echo "Processing platform: $platform"
            
            # Find all .txt files in platform folder (including subfolders)
            find "$platform" -name "*.txt" -type f | while read -r program_file; do
              
              # Extract program name from path (parent directory name)
              program_name=$(basename "$(dirname "$program_file")")
              
              # If .txt file is directly in platform folder, use filename as program name
              if [ "$(dirname "$program_file")" = "$platform" ]; then
                program_name=$(basename "$program_file" .txt)
              fi
              
              echo "  Processing program: $program_name (from $program_file)"
              
              mkdir -p "monitored-files/$platform/$program_name"
              
              # Read URLs from program file
              file_num=0
              while IFS= read -r url || [ -n "$url" ]; do
                [[ -z "$url" || "$url" =~ ^#.*$ ]] && continue
                
                file_num=$((file_num + 1))
                
                js_filename=$(echo "$url" | sed 's/.*\///' | sed 's/?.*//')
                [ -z "$js_filename" ] && js_filename="file_${file_num}.js"
                [[ ! "$js_filename" =~ \.js$ ]] && js_filename="${js_filename}.js"
                
                echo "    Fetching: $js_filename from $url"
                curl -sL --max-time 30 "$url" -o "monitored-files/$platform/$program_name/$js_filename" || \
                  echo "Failed to fetch $url"
                
              done < "$program_file"
            done
          done

      - name: Check for changes and generate diffs
        id: diff
        run: |
          changes_found=false
          changes_summary=""
          diff_content=""
          new_file_count=0
          changed_file_count=0
          
          mkdir -p baseline
          
          for platform in hackerone bugcrowd intigriti personal; do
            [ ! -d "monitored-files/$platform" ] && continue
            
            for program_dir in monitored-files/$platform/*; do
              [ ! -d "$program_dir" ] && continue
              
              program_name=$(basename "$program_dir")
              platform_name=$(basename $(dirname "$program_dir"))
              
              mkdir -p "baseline/$platform_name/$program_name"
              
              for js_file in "$program_dir"/*.js; do
                [ ! -f "$js_file" ] && continue
                
                filename=$(basename "$js_file")
                baseline_file="baseline/$platform_name/$program_name/$filename"
                
                if [ -f "$baseline_file" ]; then
                  if ! diff -q "$baseline_file" "$js_file" > /dev/null 2>&1; then
                    echo "Changes: $platform_name/$program_name/$filename"
                    changes_found=true
                    changes_summary="${changes_summary}\nüî¥ **${platform_name}/${program_name}** - ${filename}"
                    
                    changed_file_count=$((changed_file_count + 1))
                    
                    # Only show diff preview for first 3 changed files
                    if [ $changed_file_count -le 3 ]; then
                      # Generate compact diff (limit to 20 lines for Discord)
                      mkdir -p "diffs/$platform_name/$program_name"
                      diff_output=$(diff -U 3 "$baseline_file" "$js_file" 2>/dev/null | head -n 20 || echo "Diff generation failed")
                      diff_lines=$(echo "$diff_output" | wc -l)
                      
                      # Limit to 600 chars per diff
                      diff_output_short=$(echo "$diff_output" | head -c 600)
                      
                      # Add diff to content with code block
                      diff_content="${diff_content}\n\n**${platform_name}/${program_name}/${filename}:**\n\`\`\`diff\n${diff_output_short}\n"
                      if [ "$diff_lines" -eq 20 ]; then
                        diff_content="${diff_content}... (truncated)\n"
                      fi
                      diff_content="${diff_content}\`\`\`"
                    fi
                    
                    # Always save full diff to file
                    mkdir -p "diffs/$platform_name/$program_name"
                    diff -u "$baseline_file" "$js_file" > \
                      "diffs/$platform_name/$program_name/${filename}.diff" 2>&1 || true
                  fi
                else
                  echo "New baseline: $platform_name/$program_name/$filename"
                  changes_found=true
                  changes_summary="${changes_summary}\nüü¢ **${platform_name}/${program_name}** - ${filename} (new)"
                  
                  new_file_count=$((new_file_count + 1))
                  
                  # Only show preview for first 5 new files
                  if [ $new_file_count -le 5 ]; then
                    # Show first 20 lines of new file
                    new_content=$(head -n 20 "$js_file" | head -c 800)
                    line_count=$(wc -l < "$js_file")
                    
                    diff_content="${diff_content}\n\n**${platform_name}/${program_name}/${filename} (NEW):**\n\`\`\`javascript\n${new_content}\n"
                    if [ "$line_count" -gt 20 ]; then
                      diff_content="${diff_content}... (${line_count} total lines)\n"
                    fi
                    diff_content="${diff_content}\`\`\`"
                  fi
                fi
              done
            done
          done
          
          if [ "$changes_found" = true ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            
            # Limit total diff content to 2500 chars (safer limit)
            diff_content_trimmed=$(echo -e "$diff_content" | head -c 2500)
            
            # Add summary of how many files if more than shown
            if [ $changed_file_count -gt 3 ] || [ $new_file_count -gt 5 ]; then
              diff_content_trimmed="${diff_content_trimmed}\n\n_Showing preview for top files only. View full details in workflow artifacts._"
            fi
            
            # Use delimiter for safe multiline output
            {
              echo "summary<<EOFMARKER"
              echo -e "$changes_summary"
              echo "EOFMARKER"
            } >> $GITHUB_OUTPUT
            
            {
              echo "diff_output<<EOFMARKER"
              echo -e "$diff_content_trimmed"
              echo "EOFMARKER"
            } >> $GITHUB_OUTPUT
          fi

      - name: Upload diff artifacts
        if: steps.diff.outputs.changes_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: js-diffs-${{ github.run_number }}
          path: diffs/
          retention-days: 30

      - name: Generate diff summary for GitHub
        if: steps.diff.outputs.changes_detected == 'true'
        run: |
          echo "## üîç JavaScript Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          file_count=0
          for platform in hackerone bugcrowd intigriti personal; do
            [ ! -d "diffs/$platform" ] && continue
            
            for program_dir in diffs/$platform/*; do
              [ ! -d "$program_dir" ] && continue
              
              for diff_file in "$program_dir"/*.diff; do
                [ ! -f "$diff_file" ] && continue
                
                file_count=$((file_count + 1))
                
                # Limit to first 15 files in GitHub summary
                if [ $file_count -gt 15 ]; then
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**... and more files. Download artifacts to see all diffs.**" >> $GITHUB_STEP_SUMMARY
                  break 3
                fi
                
                platform_name=$(basename $(dirname $(dirname "$diff_file")))
                program_name=$(basename $(dirname "$diff_file"))
                filename=$(basename "$diff_file" .diff)
                
                echo "### üìÑ $platform_name/$program_name/$filename" >> $GITHUB_STEP_SUMMARY
                echo '```
                head -n 40 "$diff_file" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              done
            done
          done

      - name: Send Discord alert with diff
        if: steps.diff.outputs.changes_detected == 'true'
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "JS Monitor Bot"
          embed-title: "‚ö†Ô∏è JavaScript Changes Detected"
          embed-description: |
            ${{ steps.diff.outputs.summary }}
            
            **Diff Preview:**
            ${{ steps.diff.outputs.diff_output }}
            
            [View Full Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 15158332

      - name: Update baseline files
        if: steps.diff.outputs.changes_detected == 'true'
        run: |
          cp -r monitored-files/* baseline/
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add baseline/
          git commit -m "Update JS baselines [skip ci]"
          git push
