---
name: JS File Monitor

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch: {}

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean up old monitored files
        run: |
          rm -rf monitored-files diffs
          find baseline -mindepth 1 -maxdepth 1 -type d | \
          while read -r baseline_platform_dir; do
            platform=$(basename "$baseline_platform_dir")
            config_platform_dir="projsmonitor/$platform"
            if [ ! -d "$config_platform_dir" ]; then
              echo "Removing orphaned baseline platform: $platform"
              rm -rf "$baseline_platform_dir"
              continue
            fi
            find "$baseline_platform_dir" -mindepth 1 -maxdepth 1 -type d | \
            while read -r baseline_program_dir; do
              program_name=$(basename "$baseline_program_dir")
              config_exists=false
              if [ -f "$config_platform_dir/${program_name}.txt" ] || \
                 [ -d "$config_platform_dir/$program_name" ]; then
                config_exists=true
              fi
              if [ "$config_exists" = false ]; then
                echo "Removing orphaned baseline: $platform/$program_name"
                rm -rf "$baseline_program_dir"
              fi
            done
          done

      - name: Scan and fetch all JS files
        timeout-minutes: 20
        run: |
          mkdir -p monitored-files diffs
          find projsmonitor -mindepth 1 -maxdepth 1 -type d | \
          while read -r platform_dir; do
            platform=$(basename "$platform_dir")
            echo "Processing platform: $platform"
            find "$platform_dir" -name "*.txt" -type f | \
            while read -r program_file; do
              program_name=$(basename "$(dirname "$program_file")")
              if [ "$(dirname "$program_file")" = "$platform_dir" ]; then
                program_name=$(basename "$program_file" .txt)
              fi
              echo "  Processing program: $program_name (from $program_file)"
              mkdir -p "monitored-files/$platform/$program_name"
              file_num=0
              while IFS= read -r url || [ -n "$url" ]; do
                [[ -z "$url" || "$url" =~ ^#.*$ ]] && continue
                file_num=$((file_num + 1))
                js_filename=$(echo "$url" | sed 's/.*\///' | sed 's/?.*//')
                [ -z "$js_filename" ] && js_filename="file_${file_num}.js"
                [[ ! "$js_filename" =~ \.js$ ]] && \
                  js_filename="${js_filename}.js"
                echo "    Fetching: $js_filename from $url"
                curl -sL --max-time 30 "$url" \
                  -o "monitored-files/$platform/$program_name/$js_filename" \
                  || echo "Failed to fetch $url"
              done < "$program_file"
            done
          done

      - name: Check for changes and generate diffs
        id: diff
        run: |
          changes_found=false
          total_changes=0
          total_new=0
          touch changes_list.txt
          find monitored-files -mindepth 1 -maxdepth 1 -type d | \
          while read -r platform_dir; do
            find "$platform_dir" -mindepth 1 -maxdepth 1 -type d | \
            while read -r program_dir; do
              platform_name=$(basename "$platform_dir")
              program_name=$(basename "$program_dir")
              mkdir -p "baseline/$platform_name/$program_name"
              find "$program_dir" -name "*.js" -type f | \
              while read -r js_file; do
                filename=$(basename "$js_file")
                baseline_file="baseline/$platform_name/$program_name/$filename"
                if [ -f "$baseline_file" ]; then
                  if ! diff -q "$baseline_file" "$js_file" > /dev/null 2>&1; then
                    echo "Changes: $platform_name/$program_name/$filename"
                    changes_found=true
                    total_changes=$((total_changes + 1))
                    echo "CHANGED|$platform_name|$program_name|$filename" \
                      >> changes_list.txt
                    mkdir -p "diffs/$platform_name/$program_name"
                    diff -u "$baseline_file" "$js_file" > \
                      "diffs/$platform_name/$program_name/${filename}.diff" \
                      2>&1 || true
                  fi
                else
                  echo "New baseline: $platform_name/$program_name/$filename"
                  changes_found=true
                  total_new=$((total_new + 1))
                  echo "NEW|$platform_name|$program_name|$filename" \
                    >> changes_list.txt
                fi
              done
            done
          done
          if [ "$changes_found" = true ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "total_changes=$total_changes" >> $GITHUB_OUTPUT
            echo "total_new=$total_new" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord summary alert
        if: steps.diff.outputs.changes_detected == 'true'
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "JS Monitor Bot"
          embed-title: "ðŸ” JavaScript Monitoring Report"
          embed-description: >
            **Summary:**
            ðŸ”´ ${{ steps.diff.outputs.total_changes }} file(s) modified
            ðŸŸ¢ ${{ steps.diff.outputs.total_new }} new file(s) detected
            ðŸ“Š Sending detailed report for each file...
            [View Full Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            [Download All Diffs (Artifacts)](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 3447003

      - name: Send individual Discord alerts for each change
        if: steps.diff.outputs.changes_detected == 'true'
        run: |
          file_count=0
          workflow_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          while IFS='|' read -r change_type platform program filename; do
            file_count=$((file_count + 1))
            if [ "$change_type" = "CHANGED" ]; then
              baseline_file="baseline/$platform/$program/$filename"
              new_file="monitored-files/$platform/$program/$filename"
              if [ -f "$baseline_file" ] && [ -f "$new_file" ]; then
                old_content_preview=$(head -c 1500 "$baseline_file")
                new_content_preview=$(head -c 1500 "$new_file")
                json_payload=$(jq -n \
                  --arg platform "$platform" \
                  --arg program "$program" \
                  --arg filename "$filename" \
                  --arg old_content "$old_content_preview" \
                  --arg new_content "$new_content_preview" \
                  --arg url "$workflow_url" \
                  --arg count "$file_count" \
                  '{
                    "username": "JS Monitor Bot",
                    "embeds": [{
                      "title": "ðŸ”´ File Modified",
                      "description": "**Platform:** \($platform)\n**Program:** \($program)\n**File:** `\($filename)`\n\n**Previous Content:**\n```javascript\n\($old_content)\n```\n\n**New Content:**\n```javascript\n\($new_content)\n```\n\n[View Workflow Run](\($url))",
                      "color": 15158332,
                      "footer": {"text": "Modified file #\($count)"},
                      "timestamp": (now | strftime("%Y-%m-%dT%H:%M:%S.000Z"))
                    }]
                  }')
                curl -H "Content-Type: application/json" \
                  -d "$json_payload" \
                  "${{ secrets.DISCORD_WEBHOOK_URL }}"
              fi
            elif [ "$change_type" = "NEW" ]; then
              new_file="monitored-files/$platform/$program/$filename"
              if [ -f "$new_file" ]; then
                line_count=$(wc -l < "$new_file")
                file_preview=$(head -n 30 "$new_file" | head -c 2800)
                json_payload=$(jq -n \
                  --arg platform "$platform" \
                  --arg program "$program" \
                  --arg filename "$filename" \
                  --arg lines "$line_count" \
                  --arg preview "$file_preview" \
                  --arg url "$workflow_url" \
                  --arg count "$file_count" \
                  '{
                    "username": "JS Monitor Bot",
                    "embeds": [{
                      "title": "ðŸŸ¢ New File Detected",
                      "description": "**Platform:** \($platform)\n**Program:** \($program)\n**File:** `\($filename)` (\($lines) lines total)\n\n**Preview:**\n```javascript\n\($preview)\n```\n\n[View Full File](\($url))",
                      "color": 5763719,
                      "footer": {"text": "New file #\($count)"},
                      "timestamp": (now | strftime("%Y-%m-%dT%H:%M:%S.000Z"))
                    }]
                  }')
                curl -H "Content-Type: application/json" \
                  -d "$json_payload" \
                  "${{ secrets.DISCORD_WEBHOOK_URL }}"
              fi
            fi
            sleep 0.5
          done < changes_list.txt
          echo "Sent $file_count individual alerts to Discord"

      - name: Upload diff artifacts
        if: steps.diff.outputs.changes_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: js-diffs-${{ github.run_number }}
          path: diffs/
          retention-days: 30

      - name: Generate diff summary for GitHub
        if: steps.diff.outputs.changes_detected == 'true'
        run: |
          echo "## ðŸ” JavaScript Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          file_count=0
          find diffs -name "*.diff" -type f | while read -r diff_file; do
            file_count=$((file_count + 1))
            if [ $file_count -gt 20 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**... and more files. Download artifacts or check" \
                "Discord for all diffs.**" >> $GITHUB_STEP_SUMMARY
              break
            fi
            platform_name=$(basename "$(dirname "$(dirname "$diff_file")")")
            program_name=$(basename "$(dirname "$diff_file")")
            filename=$(basename "$diff_file" .diff)
            echo "### ðŸ“„ $platform_name/$program_name/$filename" \
              >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 50 "$diff_file" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done

      - name: Update baseline files
        if: steps.diff.outputs.changes_detected == 'true'
        run: |
          cp -r monitored-files/* baseline/
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add baseline/
          git commit -m "Update JS baselines [skip ci]"
          git push
