name: JS File Monitor

on:
  schedule:
    - cron: '0 */1 * * *'  # Runs every hour
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan and fetch all JS files
        run: |
          mkdir -p monitored-files diffs
          
          for platform in hackerone bugcrowd intigriti personal; do
            if [ ! -d "$platform" ]; then
              echo "Folder $platform not found, skipping..."
              continue
            fi
            
            echo "Processing platform: $platform"
            
            # Find all .txt files in platform folder (including subfolders)
            find "$platform" -name "*.txt" -type f | while read -r program_file; do
              
              # Extract program name from path (parent directory name)
              program_name=$(basename "$(dirname "$program_file")")
              
              # If .txt file is directly in platform folder, use filename as program name
              if [ "$(dirname "$program_file")" = "$platform" ]; then
                program_name=$(basename "$program_file" .txt)
              fi
              
              echo "  Processing program: $program_name (from $program_file)"
              
              mkdir -p "monitored-files/$platform/$program_name"
              
              # Read URLs from program file
              file_num=0
              while IFS= read -r url || [ -n "$url" ]; do
                [[ -z "$url" || "$url" =~ ^#.*$ ]] && continue
                
                file_num=$((file_num + 1))
                
                js_filename=$(echo "$url" | sed 's/.*\///' | sed 's/?.*//')
                [ -z "$js_filename" ] && js_filename="file_${file_num}.js"
                [[ ! "$js_filename" =~ \.js$ ]] && js_filename="${js_filename}.js"
                
                echo "    Fetching: $js_filename from $url"
                curl -sL "$url" -o "monitored-files/$platform/$program_name/$js_filename" || \
                  echo "Failed to fetch $url"
                
              done < "$program_file"
            done
          done

      - name: Check for changes and generate diffs
        id: diff
        run: |
          changes_found=false
          changes_summary=""
          diff_content=""
          
          mkdir -p baseline
          
          for platform in hackerone bugcrowd intigriti personal; do
            [ ! -d "monitored-files/$platform" ] && continue
            
            for program_dir in monitored-files/$platform/*; do
              [ ! -d "$program_dir" ] && continue
              
              program_name=$(basename "$program_dir")
              platform_name=$(basename $(dirname "$program_dir"))
              
              mkdir -p "baseline/$platform_name/$program_name"
              
              for js_file in "$program_dir"/*.js; do
                [ ! -f "$js_file" ] && continue
                
                filename=$(basename "$js_file")
                baseline_file="baseline/$platform_name/$program_name/$filename"
                
                if [ -f "$baseline_file" ]; then
                  if ! diff -q "$baseline_file" "$js_file" > /dev/null 2>&1; then
                    echo "Changes: $platform_name/$program_name/$filename"
                    changes_found=true
                    changes_summary="${changes_summary}\nüî¥ **${platform_name}/${program_name}** - ${filename}"
                    
                    # Generate compact diff (limit to 25 lines for Discord)
                    mkdir -p "diffs/$platform_name/$program_name"
                    diff_output=$(diff -U 3 "$baseline_file" "$js_file" | head -n 25)
                    diff_lines=$(echo "$diff_output" | wc -l)
                    
                    # Add diff to content with code block
                    diff_content="${diff_content}\n\n**${platform_name}/${program_name}/${filename}:**\n\`\`\`diff\n${diff_output}\n"
                    if [ "$diff_lines" -eq 25 ]; then
                      diff_content="${diff_content}... (truncated)\n"
                    fi
                    diff_content="${diff_content}\`\`\`"
                    
                    # Save full diff to file
                    diff -u "$baseline_file" "$js_file" > \
                      "diffs/$platform_name/$program_name/${filename}.diff" 2>&1 || true
                  fi
                else
                  echo "New baseline: $platform_name/$program_name/$filename"
                  changes_found=true
                  changes_summary="${changes_summary}\nüü¢ **${platform_name}/${program_name}** - ${filename} (new)"
                  
                  # Show first 20 lines of new file
                  new_content=$(head -n 20 "$js_file")
                  line_count=$(wc -l < "$js_file")
                  
                  diff_content="${diff_content}\n\n**${platform_name}/${program_name}/${filename} (NEW):**\n\`\`\`javascript\n${new_content}\n"
                  if [ "$line_count" -gt 20 ]; then
                    diff_content="${diff_content}... (${line_count} total lines)\n"
                  fi
                  diff_content="${diff_content}\`\`\`"
                fi
              done
            done
          done
          
          if [ "$changes_found" = true ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            
            # Limit total diff content to 3500 chars (safe for Discord 4096 limit)
            diff_content_trimmed=$(echo -e "$diff_content" | head -c 3500)
            
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo -e "$changes_summary" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "diff_output<<EOF" >> $GITHUB_OUTPUT
            echo -e "$diff_content_trimmed" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Upload diff artifacts
        if: steps.diff.outputs.changes_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: js-diffs-${{ github.run_number }}
          path: diffs/
          retention-days: 30

      - name: Generate diff summary for GitHub
        if: steps.diff.outputs.changes_detected == 'true'
        run: |
          echo "## üîç JavaScript Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for platform in hackerone bugcrowd intigriti personal; do
            [ ! -d "diffs/$platform" ] && continue
            
            for program_dir in diffs/$platform/*; do
              [ ! -d "$program_dir" ] && continue
              
              for diff_file in "$program_dir"/*.diff; do
                [ ! -f "$diff_file" ] && continue
                
                platform_name=$(basename $(dirname $(dirname "$diff_file")))
                program_name=$(basename $(dirname "$diff_file"))
                filename=$(basename "$diff_file" .diff)
                
                echo "### üìÑ $platform_name/$program_name/$filename" >> $GITHUB_STEP_SUMMARY
                echo '```
                head -n 50 "$diff_file" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              done
            done
          done

      - name: Send Discord alert with diff
        if: steps.diff.outputs.changes_detected == 'true'
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "JS Monitor Bot"
          embed-title: "‚ö†Ô∏è JavaScript Changes Detected"
          embed-description: |
            ${{ steps.diff.outputs.summary }}
            
            **Diff Preview:**
            ${{ steps.diff.outputs.diff_output }}
            
            [View Full Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 15158332

      - name: Update baseline files
        if: steps.diff.outputs.changes_detected == 'true'
        run: |
          cp -r monitored-files/* baseline/
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add baseline/
          git commit -m "Update JS baselines [skip ci]"
          git push
